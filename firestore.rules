rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      // Admin tiene acceso TOTAL - solo verificar el email
      return isSignedIn() && (
        request.auth.token.email == 'admin@congreso.mx' ||
        request.auth.token.email == 'admin@congreso.com'
      );
    }
    
    // ============================================
    // ADMIN TOTAL ACCESS - Acceso completo a TODO si no hay regla más específica
    // ============================================
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Un usuario puede crear su propio perfil
      allow create: if isSignedIn() && isOwner(userId);
      
      // Un usuario solo puede leer su propio perfil.
      // El admin puede leer cualquier perfil (ver regla general arriba).
      allow get: if isSignedIn() && isOwner(userId);
      
      // SOLO ADMINS pueden listar todos los usuarios (para /admin/usuarios).
      allow list: if isAdmin();
      
      // Un usuario solo puede actualizar su propio perfil.
      allow update: if isSignedIn() && isOwner(userId);
      
      // Nadie puede borrar perfiles (excepto admin).
      allow delete: if false;
      
      // Subcolección de asistencia de un usuario
      match /attendance/{attendanceId} {
        // Un usuario puede leer y crear sus propios registros de asistencia
        allow read, create: if isSignedIn() && isOwner(userId);
        
        // Nadie más puede actualizar o borrar registros de asistencia (excepto admin)
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // CUALQUIERA puede leer eventos (para la agenda pública y la de usuarios logueados).
      allow get, list: if true;
      
      // Solo admins pueden crear, actualizar o eliminar eventos
      allow create, update, delete: if isAdmin();
      
      // Subcolección de asistentes a un evento
      match /attendees/{attendeeId} {
        // Usuarios logueados pueden ver quién asistió.
        allow get, list: if isSignedIn();
        
        // Un usuario puede registrar su propia asistencia (al escanear QR).
        allow create: if isSignedIn() && request.auth.uid == attendeeId;
        
        // Nadie puede borrar registros (excepto admin).
        allow delete: if false;
      }
    }

    // ============================================
    // PUBLIC CONTENT COLLECTIONS
    // ============================================
    
    match /speakers/{speakerId} {
      allow read: if true; // Lectura pública para la página de ponentes
      allow write: if isAdmin(); // Solo admin puede modificar
    }
    
    match /sponsors/{sponsorId} {
      allow read: if true; // Lectura pública para la página principal
      allow write: if isAdmin();
    }
    
    match /featuredEvents/{eventId} {
      allow read: if true; // Lectura pública para la página principal
      allow write: if isAdmin();
    }
    
    match /retofit_flyers/{flyerId} {
      allow read: if true; // Lectura pública para la página #RetoFIT
      allow write: if isAdmin();
    }
  }
}
